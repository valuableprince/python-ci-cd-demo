name: Python Tests and Checks

on:  # Когда запускать workflow
  push:  # При каждом пуше
    branches: [ main, develop ]
  pull_request:  # При создании Pull Request
    branches: [ main ]

jobs:  # Задачи, которые будут выполнены
  test:  # Первая задача - тестирование
    runs-on: ubuntu-latest  # На какой операционной системе запускать

    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11"]  # Тестируем на разных версиях Python

    steps:  # Шаги выполнения задачи
    - uses: actions/checkout@v3  # Шаг 1: Клонируем репозиторий

    - name: Set up Python ${{ matrix.python-version }}  # Шаг 2: Устанавливаем Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies  # Шаг 3: Устанавливаем зависимости
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests with pytest  # Шаг 4: Запускаем тесты
      run: |
        pytest -v

    - name: Run tests with coverage  # Шаг 5: Запускаем тесты с покрытием
      run: |
        pytest --cov=calculator --cov-report=xml

    - name: Upload coverage to Codecov  # Шаг 6: Загружаем отчет о покрытии (опционально)
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false  # Не прерывать CI если не удалось загрузить

  lint:  # Вторая задача - проверка стиля кода
    runs-on: ubuntu-latest
    needs: test  # Запускаем только если тесты прошли

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install flake8  # Устанавливаем линтер
      run: |
        pip install flake8

    - name: Lint with flake8  # Проверяем стиль кода
      run: |
        flake8 calculator.py test_calculator.py --count --max-complexity=10 --statistics

  build-docs:  # Третья задача - сборка документации
    runs-on: ubuntu-latest
    needs: test  # Запускаем только если тесты прошли

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Generate documentation  # Генерируем простую документацию
      run: |
        echo "# Документация калькулятора" > README.md
        echo "" >> README.md
        echo "## Описание" >> README.md
        echo "Простой калькулятор для демонстрации CI/CD" >> README.md
        echo "" >> README.md
        echo "## Результаты тестов" >> README.md
        echo "![Тесты пройдены](https://github.com/${{ github.repository }}/actions/workflows/python-tests.yml/badge.svg)" >> README.md

    - name: Upload documentation  # Сохраняем документацию как артефакт
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: README.md